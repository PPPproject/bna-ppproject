<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>My map</title>
<script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>

<style>

.base {
    fill: #f0e4dd;
    fill-opacity: 0;
    stroke: black;
    stroke-width: 1.5;
}

</style>
</head>

<body>
    <div id="container" class="svg-container"></div>


    <script type="text/javascript">
    //template stuff
    var w = 1400;
    var h = 700;
    var svg = d3.select("div#container").append("svg").attr("preserveAspectRatio", "xMinYMin meet")
    .attr("viewBox", "0 0 " + w + " " + h).style("background","#c9e8fd")
    .classed("svg-content", true);

    var projection = d3.geoMercator()
                        .scale(1000 * 2)
			            .center([-120, 36])
			            .translate([w/2, h/2]);

    /*
    //projections from LA Times Observable
                         .center([-119, 37.4])
                         //edited
                         .scale(50)
                         .translate([320, 320])
    */
                        
    var path = d3.geoPath().projection(projection);
    
   
    var map = d3.json("calitopoSimple.topojson")
    var data = d3.csv("county_pc_rates.csv")
   
    var color = d3.scaleQuantize([0,3000],d3.schemeGreens[9])
    

    


    


    Promise.all([map, data]).then(function(values){

        //converts topojson to geojson
        var topo = values[0]
        console.log(topo)
        console.log(topo.objects.subunits)
        var geo = (topojson.feature(topo, topo.objects.subunits))  
        console.log(geo)

       // console.log(values[0])
       // console.log(values[0].features)
        console.log(values[1])

        var countyData = values[1]

       

        svg.append("g")
            .selectAll("path")
            .data(geo.features)
            .enter()
            .append("path")
            //.join("path")
                .attr("d", path)
                .attr("class","county")
                //image attributes
                .attr("stroke", "black")
                .attr("stroke-width", 1)
                .attr("fill", "blue")

                
                .attr("fill", function(d){
                    var stat = 0
                    for(let i=0; i<countyData.length; i++){
                        
                        if(countyData[i]["ProjectCountyName"]==d.properties["name"].toUpperCase()){
                           // console.log(countyData[i]["pc.curr.app.amt"])
                            stat = countyData[i]["pc.curr.app.amt"]
                            break;
                        }
                    }
                    //console.log(stat)
                    return color(stat);
                }
                )

                
                
                .attr("fill-opacity", 1)
                .attr("fill-rule", "nonzero")

                //tooltip!
                .on('click', function(d, i) {
                    var stat = 0
                    for(let i=0; i<countyData.length; i++){
                        
                        if(countyData[i]["ProjectCountyName"]==d.properties["name"].toUpperCase()){
                            
                            console.log(d.properties["name"]+" population: "+countyData[i]["pop"])
                            stat = countyData[i]["pop"]
                            break;
                        }
                    }

                    d3.select(this)
                    .transition()
                    .duration(100)
                    .attr("fill-opacity", 1)    
                    })
                
  
    });

   
    </script>

</body>
</html>